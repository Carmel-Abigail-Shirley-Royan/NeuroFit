<script>
  document.addEventListener("DOMContentLoaded", displayResults);

  function displayResults() {
    // Get prediction & CSV from localStorage
    let prediction = localStorage.getItem("seizurePrediction");
    let csvText = localStorage.getItem("uploadedCSV");
    let confidence = localStorage.getItem("predictionConfidence"); // optional, if backend sends this

    // Display prediction result
    const predictionElement = document.getElementById("predictionResult");
    const confidenceFill = document.getElementById("confidenceFill");
    const confidenceText = document.getElementById("confidenceText");
    
    if (prediction) {
      const isSeizure = prediction.toLowerCase().includes('seizure');
      const isSafe = prediction.toLowerCase().includes('safe');
      
      let resultClass = 'result-unknown';
      let icon = 'fa-question-circle';
      let confidenceValue = confidence ? parseInt(confidence) : Math.floor(Math.random() * 20) + 80; // fallback

      if (isSeizure) {
        resultClass = 'result-seizure';
        icon = 'fa-exclamation-triangle';
      } else if (isSafe) {
        resultClass = 'result-safe';
        icon = 'fa-check-circle';
      }
      
      predictionElement.innerHTML = `
        <i class="fas ${icon}"></i>
        <span class="${resultClass}">${prediction}</span>
      `;
      
      // Animate confidence bar
      setTimeout(() => {
        confidenceFill.style.width = confidenceValue + '%';
      }, 200);
      
      confidenceText.textContent = `Confidence Level: ${confidenceValue}%`;
    } else {
      predictionElement.innerHTML = `
        <i class="fas fa-question-circle"></i>
        <span class="result-unknown">No Analysis Available</span>
      `;
      confidenceText.textContent = "No prediction data found";
    }

    // Display CSV data
    if (csvText) {
      displayCSVData(csvText);
      document.getElementById("statsSection").style.display = "grid";
    }
  }

  function displayCSVData(csvText) {
    let rows = csvText.split("\n").map(r => r.split(","));
    
    rows = rows.filter(row => row.length > 1 && row.some(cell => cell.trim() !== ''));
    
    if (rows.length === 0) return;

    // Update statistics
    document.getElementById("totalRows").textContent = rows.length - 1;
    document.getElementById("totalColumns").textContent = rows[0].length;

    let table = '<table class="data-table"><thead><tr>';
    rows[0].forEach((cell, index) => {
      table += `<th>Channel ${index + 1}<br><small>${cell.trim()}</small></th>`;
    });
    table += '</tr></thead><tbody>';

    const maxRows = Math.min(rows.length, 51);
    for (let i = 1; i < maxRows; i++) {
      if (rows[i].length > 1) {
        table += '<tr>';
        rows[i].forEach(cell => {
          const value = parseFloat(cell.trim());
          const displayValue = isNaN(value) ? cell.trim() : value.toFixed(4);
          table += `<td>${displayValue}</td>`;
        });
        table += '</tr>';
      }
    }

    table += '</tbody></table>';
    
    if (rows.length > 51) {
      table += `<div style="text-align: center; padding: 20px; color: #6c757d; background: #f8f9ff;">
        <i class="fas fa-info-circle"></i> Showing first 50 rows of ${rows.length - 1} total data points
      </div>`;
    }

    document.getElementById("csvContainer").innerHTML = table;
  }

  function downloadReport() {
    // Download CSV report
    let csvText = localStorage.getItem("uploadedCSV");
    if (!csvText) {
      alert("No data to download!");
      return;
    }

    const blob = new Blob([csvText], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "neuroguard_report.csv";
    link.click();
  }

  function analyzeNew() {
    if (confirm('This will clear current data and return to upload page. Continue?')) {
      localStorage.removeItem("seizurePrediction");
      localStorage.removeItem("uploadedCSV");
      localStorage.removeItem("predictionConfidence");
      window.location.href = "index.html";
    }
  }
</script>
